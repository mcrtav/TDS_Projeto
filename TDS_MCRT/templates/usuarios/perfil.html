{% extends 'frontend/base.html' %}

{% block title %}Perfil do Usuário{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/perfil.css">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-4">
      <!-- Card de informações do perfil -->
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-user-circle me-2"></i> Foto do Perfil
          </h5>
        </div>
        <div class="card-body text-center">
          <div class="profile-img-container mb-3">
            <img
              src="{{ usuario.get_foto_url }}?t={{ timestamp }}"
              class="rounded-circle profile-img"
              alt="Foto de perfil"
              id="perfil-foto"
              loading="lazy"
            />

            <!-- Overlay para trocar foto -->
            <div
              class="profile-img-overlay"
              onclick="document.getElementById('foto-input').click()"
            >
              <div class="text-white">
                <i class="fas fa-camera fa-2x"></i>
                <p class="mb-0 mt-2">Trocar</p>
              </div>
            </div>
          </div>

          <!-- Input file oculto -->
          <input
            type="file"
            id="foto-input"
            accept="image/*"
            style="display: none"
          />

          <h4>{{ usuario.nome }}</h4>
          <p class="text-muted">{{ usuario.email }}</p>

          <!-- Estatísticas do perfil -->
          <div class="profile-stats mt-3">
            <div class="stat-item mb-2">
              <i class="fas fa-heart text-danger me-2"></i>
              <span id="favoritos-count">0</span> Favoritos
            </div>
            <div class="stat-item">
              <i class="fas fa-calendar text-info me-2"></i>
              Membro desde {{ usuario.criado|date:"d/m/Y" }}
            </div>
          </div>

          <div class="mt-3">
            <button
              class="btn btn-primary me-2"
              onclick="document.getElementById('foto-input').click()"
            >
              <i class="fas fa-camera me-1"></i> Alterar Foto
            </button>
            <button
              class="btn btn-outline-danger"
              onclick="perfil.removerFotoPerfil()"
            >
              <i class="fas fa-trash me-1"></i> Remover Foto
            </button>
          </div>
        </div>
      </div>

      <!-- Card de resumo -->
      <div class="card shadow">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Resumo</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted">Último acesso</small>
            <p class="mb-0">
              {% if usuario.last_login %}
                {{ usuario.last_login|date:"d/m/Y H:i" }}
              {% else %}
                Primeiro acesso
              {% endif %}
            </p>
          </div>
          <div class="mb-3">
            <small class="text-muted">Conta criada em</small>
            <p class="mb-0">{{ usuario.criado|date:"d/m/Y" }}</p>
          </div>
          <div>
            <small class="text-muted">Última atualização</small>
            <p class="mb-0">{{ usuario.atualizado|date:"d/m/Y H:i" }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <!-- Área para mensagens -->
      <div id="alert-container"></div>

      <!-- Card de informações pessoais -->
      <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-id-card me-2"></i> Informações Pessoais
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Nome Completo</label>
              <p class="form-control-plaintext fw-bold">{{ usuario.nome }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">E-mail</label>
              <p class="form-control-plaintext">{{ usuario.email }}</p>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Status da Conta</label>
              <p class="form-control-plaintext">
                {% if usuario.is_active %}
                <span class="badge bg-success">Ativa</span>
                {% else %}
                <span class="badge bg-danger">Inativa</span>
                {% endif %}
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Tipo de Usuário</label>
              <p class="form-control-plaintext">
                {% if usuario.is_superuser %}
                <span class="badge bg-danger">Superusuário</span>
                {% elif usuario.is_staff %}
                <span class="badge bg-warning">Administrador</span>
                {% else %}
                <span class="badge bg-info">Usuário</span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Card de endereço -->
      <div class="card shadow mb-4">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0">
            <i class="fas fa-map-marker-alt me-2"></i> Endereço
          </h5>
        </div>
        <div class="card-body">
          {% if usuario.cep %}
          <div class="row">
            <div class="col-md-3 mb-3">
              <label class="form-label text-muted">CEP</label>
              <p class="form-control-plaintext">{{ usuario.cep_formatado }}</p>
            </div>
            <div class="col-md-9 mb-3">
              <label class="form-label text-muted">Logradouro</label>
              <p class="form-control-plaintext">
                {{ usuario.logradouro }} {% if usuario.numero %}, {{ usuario.numero }}{% endif %} {% if usuario.complemento %} - {{ usuario.complemento }}{% endif %}
              </p>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label text-muted">Bairro</label>
              <p class="form-control-plaintext">{{ usuario.bairro }}</p>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label text-muted">Cidade</label>
              <p class="form-control-plaintext">{{ usuario.cidade }}</p>
            </div>
            <div class="col-md-2 mb-3">
              <label class="form-label text-muted">Estado</label>
              <p class="form-control-plaintext">{{ usuario.estado }}</p>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label text-muted">Endereço Completo</label>
            <p class="form-control-plaintext" id="endereco-completo">
              {{ usuario.get_endereco_completo }}
            </p>
          </div>
          {% else %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Nenhum endereço cadastrado.
            <a href="/perfil/editar" class="alert-link">Clique aqui para adicionar</a>.
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Card de ações -->
      <div class="card shadow">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0"><i class="fas fa-cog me-2"></i> Ações</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <a href="/perfil/editar" class="btn btn-outline-primary w-100">
                <i class="fas fa-edit me-2"></i> Editar Perfil
              </a>
            </div>
            <div class="col-md-6 mb-3">
              <a href="/favoritos" class="btn btn-outline-success w-100">
                <i class="fas fa-heart me-2"></i> Meus Favoritos
              </a>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <a href="/recuperar-senha" class="btn btn-outline-warning w-100">
                <i class="fas fa-key me-2"></i> Alterar Senha
              </a>
            </div>
            <div class="col-md-6 mb-3">
              <button class="btn btn-outline-danger w-100" onclick="perfil.logout()">
                <i class="fas fa-sign-out-alt me-2"></i> Sair
              </button>
            </div>
          </div>

          {% if not usuario.is_superuser %}
          <div class="alert alert-warning mt-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Atenção:</strong> Algumas funcionalidades podem estar
            limitadas para sua conta. Contate o administrador do sistema para
            mais informações.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para upload -->
<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Alterar Foto de Perfil</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="upload-progress" class="d-none">
          <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%"></div>
          </div>
          <p class="text-center">Enviando...</p>
        </div>
        
        <div id="upload-form">
          <div class="mb-3">
            <label for="foto-file" class="form-label">Selecione uma imagem</label>
            <input type="file" class="form-control" id="foto-file" accept="image/*">
            <div class="form-text">
              Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 5MB.
            </div>
          </div>
          <div class="mb-3 text-center">
            <img id="preview-image" class="img-thumbnail d-none" 
                 style="max-width: 200px; max-height: 200px;">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="perfil.confirmarUpload()">Enviar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/perfil.js"></script>
<script>
// Inicialização quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
    perfil.init();
});
</script>
{% endblock %}